<!DOCTYPE html>
<script src="https://d3js.org/d3.v4.min.js"></script>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="heading">
        <h>Covid-19 and Google Searches</h>
        <p>Tracking spikes in Google searches for <b>"covid symptoms"</b> and spikes in Covid-19 cases by state.</p>
    </div>

    <div id='container' class='maps'>

        <button id="play-button">Play</button>
        <div id='label'>Press play to begin, or drag the time slider.</div>
        <div id="slider"></div>
    </div>
    <script>
        var currentDate = 0;
        const startDate = new Date("2020-02-01");
        var endDate = new Date("2020-07-19");

        // function to get Date from start date 
        Date.prototype.addDays = function(days) {
            date.setDate(startDate + days);
            return date;
        }

        // functions to pretty print dates
        var getMonth = d3.timeFormat("%B");
        var getMonthAndYear = d3.timeFormat("%B %d %Y");
        
        // initialize SVG parameters
        var margin = { top: 50, right: 50, bottom: 0, left: 50 },
            width = 1000 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom,
            targetValue = width;

        var x = d3.scaleLinear()
            .domain([0, 135])
            .range()
        var datesScale = d3.scaleTime()
            .domain([startDate, endDate])
            .range([80, targetValue * 0.9])
            .clamp(true);

        var svg = d3.select('.maps')
            .append("svg")
            .attr('preserveAspectRatio', 'none')
            .attr('viewBox', '0 0 ' + width + ' ' + height);

        var slider = svg.append("g")
            .attr("class", "slider")
            .attr("transform", "translate(0," + height / 5 + ")");

        slider.append("line")
            .attr("class", "track")
            .attr("x1", "10%")
            .attr("x2", "90%")
            .select(function () {
                return this.parentNode.appendChild(this.cloneNode(true));
            })
            .attr("class", "track_inner")
            .attr("x1", "10%")
            .attr("x2", "90%")
            .select(function () {
                return this.parentNode.appendChild(this.cloneNode(true));
            })
            .attr("class", "track_outer")
            .attr("x1", "10%")
            .attr("x2", "90%")
            .call(d3.drag()
                .on("drag", function () {
                    console.log("In drag");
                    new_val = d3.event.x;
                    moveHandle(datesScale.invert(new_val));
                }));

        slider.insert("g", ".track_outer")
            .attr("class", "slider_marks")
            .attr("transform", "translate(0," + 18 + ")")
            .selectAll("text")
            .data(datesScale.ticks(10))
            .enter()
            .append("text")
            .attr("x", datesScale)
            .attr("y", 10)
            .attr("text-anchor", "middle")
            .text(function (d) { return getMonth(d); });

        var handle = slider.insert("circle", ".track_outer")
            .attr("class", "handle")
            .attr("transform", "translate(80,0)")
            .attr("r", 9);

        var dateLabel = slider.append('text')
                .attr('class', 'dateLabel')
                .attr('text-anchor', 'middle')
                .text(getMonthAndYear(startDate))
                .attr('transform', 'translate(80,' + (-25) + ')')

        function moveHandle(date) {
            console.log(date);
            handle.attr("cx", datesScale(date) - 80);
            dateLabel.attr('x', datesScale(date) - 80);
            dateLabel.text(getMonthAndYear(date));
            updateMap(date);
        }




        // // Map

        var projection_google = d3.geoAlbersUsa()
            .scale(500)
            .translate([width / 4, 3 * height / 4]);
        // geoPath is library simply turns lat/lon into screen coordinates
        var path_g = d3.geoPath()
            .projection(projection_google);
        var projection_covid = d3.geoAlbersUsa()
            .scale(500)
            .translate([3 * width / 4, 3 * height / 4]);
        // geoPath is library simply turns lat/lon into screen coordinates
        var path_c = d3.geoPath()
            .projection(projection_covid);
        var g = svg.append("g");
        svg.append('text')
            .attr("transform", "translate(" + 165 + "," + 210 + ")")
            .text('Google Trends');
        svg.append('text')
            .attr("transform", "translate(" + 590 + "," + 210 + ")")
            .text('New Daily Covid Cases');

        // tooltip for mouseover details
        var tooltip = svg.append('g')
            .attr('class', 'tooltip')
            .style('opacity', 0);
        // // initialize d3 components
        var colors = d3.scaleLinear()
            .domain([0, 50/3, 100/3, 150/3, 200/3, 250/3, 100])
            .range(['black', 'blue', 'cyan', 'green', 'yellow', 'red']);

        // us geo json source: https://eric.clst.org/tech/usgeojson/
        d3.json('data/data.json', function (json) {
            g.selectAll("path_g")
                .data(json.features)
                .enter()
                .append("path")
                .attr("class", "state_g")
                .attr("name", function(d) { return d.properties.NAME; })
                .attr("fill", colors(0))
                .attr("stroke", "#333")
                .attr("d", path_g);
            g.selectAll("path_c")
                .data(json.features)
                .enter()
                .append("path")
                .attr("class", "state_c")
                .attr("name", function(d) { return d.properties.NAME; })
                .attr("fill", colors(0))
                .attr("stroke", "#333")
                .attr("d", path_c);
            console.log(json);
        });

        // update map on slider movement
        function updateMap(date) {
            // get new date diff between start date and this date
            var diffTime = Math.abs(date - startDate);
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            console.log('Diff days: ' + diffDays);

            // re-draw map components with color
            // corresponding to data for that state

            // update mouseovers
            g.selectAll(".state_g")
                .on("mouseover", function(d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = (Object.values(dlist[1]["value"]["googleData"]))[diffDays];
                    } catch(err) {
                        // meh
                    }
                    tooltip.transition()		
                        .duration(200)		
                        .style("opacity", .9);		
                    tooltip.html(d.properties.NAME + "<br/>"  + dataPoint)	
                        .style("left", (d3.event.x) + "px")		
                        .style("top", (d3.event.x - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0);
                });
            g.selectAll(".state_c")
                .on("mouseover", function(d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = (Object.values(dlist[1]["value"]["covidData"]))[diffDays];
                    } catch(err) {
                        // meh
                    }
                    tooltip.transition()		
                        .duration(200)		
                        .style("opacity", .9);		
                    tooltip.html(d.properties.NAME + "<br/>"  + dataPoint)	
                        .style("left", (d3.event.x) + "px")		
                        .style("top", (d3.event.x - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0);
                });

            // update map colors
            g.selectAll(".state_g")
                .transition()
                .duration(200)
                .attr("fill", function(d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = (Object.values(dlist[1]["value"]["googleData"]))[diffDays];
                    } catch(err) {
                        // meh
                    }
                    return colors(dataPoint);
                });
            g.selectAll(".state_c")
                .transition()
                .duration(200)
                .attr("fill", function(d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = (Object.values(dlist[1]["value"]["covidData"]))[diffDays];
                    } catch(err) {
                        // meh
                    }
                    return colors(dataPoint);
                });
        }


    </script>



</body>