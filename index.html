<!DOCTYPE html>
<script src="https://d3js.org/d3.v4.min.js"></script>

<head>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="heading">
        <h>Googling the Pandemic</h>
    </div>

    <div class="subtitle">
        Covid-19
    </div>

    <div class="story">
        <p>
            Over the last eight months, the world has been devasted by the coronavirus outbreak, now reaching <b>over 10,000,000 cases</b> and <b>500,000 deaths</b> worldwide. Many countries have been brought to a complete standstill, with hospitals overwhelmed and the economy tested in what may been the worst recession since World War II.
        </p>
        <p>
            The first U.S. cases were confirmed in late January in Washington state. Over the next ten days, the global cases climbed by 10,000 and the WHO issued a Global Health Emergency. Community cases began to appear in the U.S. and the disease spread rapidly. In early March, a cruise ship off of California was confirmed to have 21 passengers confirmed positive for coronavirus, and was held at sea. On March 13, after the <b>disease was coined "Covid-19"</b>, the Trump administration declared it a National Emergency and banned travel from Europe.
        </p>
        <p>
            Cases in the U.S. climbed exponentially, and continue to climb to this day. Different states issued different policies, resulting in very different outcomes for citizens. 
            While <a href="https://www.michigan.gov/coronavirus/0,9753,7-406-98178_98455_98456_100804---,00.html">Michigan issued a number of executive orders</a> requiring the closing of schools and non-essential businesses, and requiring masks indoors, other states did not follow suit - despite seeing similar climbing numbers.
            By June, the U.S. had passed <b>100,000 deaths</b> and <b>2 million infections</b>
        </p>
    </div>

    <div class="subtitle">
        Google Trends
    </div>

    <div class="story">
        <p>
            We can use Google Trends to see asdkfjasdl asdkjfhsd blah blah blah
        </p>
        <p>
            This allows us to track spikes in blah blah blah
        </p>
    </div>

    <div id='container' class='maps'>

        <button id="play-button">Play</button>
        <div id='label'>Press play to begin, or drag the time slider.</div>
        <div id="slider"></div>
    </div>
    <script>
        const startDate = new Date("2020-02-01");
        var currentDate = new Date("2020-02-01");
        var endDate = new Date("2020-07-18");
        endDate.setHours(0,0,0,0);

        // functions to pretty print dates
        var getMonth = d3.timeFormat("%B");
        var getMonthAndYear = d3.timeFormat("%B %d %Y");

        // initialize SVG parameters
        var margin = { top: 50, right: 50, bottom: 0, left: 50 },
            width = 1000 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom,
            targetValue = width;

        var x = d3.scaleLinear()
            .domain([0, 135])
            .range()
        var datesScale = d3.scaleTime()
            .domain([startDate, endDate])
            .range([80, targetValue * 0.9])
            .clamp(true);

        var svg = d3.select('.maps')
            .append("svg")
            .attr('preserveAspectRatio', 'none')
            .attr('viewBox', '0 0 ' + width + ' ' + 600);

        var slider = svg.append("g")
            .attr("class", "slider")
            .attr("transform", "translate(0," + height / 5 + ")");

        slider.append("line")
            .attr("class", "track")
            .attr("x1", "10%")
            .attr("x2", "90%")
            .select(function () {
                return this.parentNode.appendChild(this.cloneNode(true));
            })
            .attr("class", "track_inner")
            .attr("x1", "10%")
            .attr("x2", "90%")
            .select(function () {
                return this.parentNode.appendChild(this.cloneNode(true));
            })
            .attr("class", "track_outer")
            .attr("x1", "10%")
            .attr("x2", "90%")
            .call(d3.drag()
                .on("drag", function () {
                    new_val = d3.event.x;
                    moveHandle(datesScale.invert(new_val));
                }));

        slider.insert("g", ".track_outer")
            .attr("class", "slider_marks")
            .attr("transform", "translate(0," + 18 + ")")
            .selectAll("text")
            .data(datesScale.ticks(10))
            .enter()
            .append("text")
            .attr("x", datesScale)
            .attr("y", 10)
            .attr("text-anchor", "middle")
            .text(function (d) { return getMonth(d); });

        var handle = slider.insert("circle", ".track_outer")
            .attr("class", "handle")
            .attr("transform", "translate(80,0)")
            .attr("r", 9);

        var dateLabel = slider.append('text')
            .attr('class', 'dateLabel')
            .attr('text-anchor', 'middle')
            .text(getMonthAndYear(startDate))
            .attr('transform', 'translate(80,' + (-25) + ')')

        function moveHandle(date) {
            currentDate = date;
            handle.attr("cx", datesScale(date) - 80);
            dateLabel.attr('x', datesScale(date) - 80);
            dateLabel.text(getMonthAndYear(date));
            updateMap();
        }




        // // Map

        var projection_google = d3.geoAlbersUsa()
            .scale(500)
            .translate([width / 4, 3 * height / 4]);
        // geoPath is library simply turns lat/lon into screen coordinates
        var path_g = d3.geoPath()
            .projection(projection_google);
        var projection_covid = d3.geoAlbersUsa()
            .scale(500)
            .translate([3 * width / 4, 3 * height / 4]);
        // geoPath is library simply turns lat/lon into screen coordinates
        var path_c = d3.geoPath()
            .projection(projection_covid);
        var g = svg.append("g");
        svg.append('text')
            .attr("transform", "translate(" + 165 + "," + 210 + ")")
            .text('Google Trends');
        svg.append('text')
            .attr("transform", "translate(" + 590 + "," + 210 + ")")
            .text('New Daily Covid Cases');

        // tooltip for mouseover details
        var hover = d3.select('.maps').append('div')
            .attr('class', 'tooltip')
            .style('opacity', 0);
        // // initialize d3 components
        var colors = d3.scaleLinear()
            .domain([0, 50 / 3, 100 / 3, 150 / 3, 200 / 3, 250 / 3, 100])
            .range(['black', 'blue', 'cyan', 'green', 'yellow', 'orange', 'red']);

        // us geo json source: https://eric.clst.org/tech/usgeojson/
        d3.json('data/data.json', function (json) {
            g.selectAll("path_g")
                .data(json.features)
                .enter()
                .append("path")
                .attr("class", "state_g")
                .attr("name", function (d) { return d.properties.NAME; })
                .attr("fill", colors(0))
                .attr("stroke", "#333")
                .attr("d", path_g)
                .on("mouseover", function (d) {
                    hover.transition()
                        .duration(200)
                        .style("opacity", .9);
                    hover.html(d.properties.NAME + "<br/>" + 0)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 40) + "px");
                })
                .on("mouseout", function () {
                    hover.transition()
                        .duration(200)
                        .style("opacity", 0);
                });
            g.selectAll("path_c")
                .data(json.features)
                .enter()
                .append("path")
                .attr("class", "state_c")
                .attr("name", function (d) { return d.properties.NAME; })
                .attr("fill", colors(0))
                .attr("stroke", "#333")
                .attr("d", path_c)
                .on("mouseover", function (d) {
                    hover.transition()
                        .duration(200)
                        .style("opacity", .9);
                    hover.html(d.properties.NAME + "<br/>" + 0)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 40) + "px");
                })
                .on("mouseout", function () {
                    hover.transition()
                        .duration(200)
                        .style("opacity", 0);
                });
        });

        // update map on slider movement
        function updateMap() {
            // get new date diff between start date and this date
            var diffTime = Math.abs(currentDate - startDate);
            var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // re-draw map components with color
            // corresponding to data for that state

            // update mouseovers
            g.selectAll(".state_g")
                .on("mouseover", function (d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = Math.round((Object.values(dlist[1]["value"]["googleData"]))[diffDays]);
                    } catch (err) {
                        // meh
                    }
                    hover.transition()
                        .duration(200)
                        .style("opacity", .9);
                    hover.html(d.properties.NAME + "<br/>" + dataPoint)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 40) + "px");
                })
                .on("mouseout", function () {
                    hover.transition()
                        .duration(200)
                        .style("opacity", 0);
                });
            g.selectAll(".state_c")
                .on("mouseover", function (d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = Math.round((Object.values(dlist[1]["value"]["covidData"]))[diffDays]);
                    } catch (err) {
                        // meh
                    }
                    hover.transition()
                        .duration(200)
                        .style("opacity", .9);
                    hover.html(d.properties.NAME + "<br/>" + dataPoint)
                        .style("left", (d3.event.pageX) + "px")
                        .style("top", (d3.event.pageY - 40) + "px");
                })
                .on("mouseout", function () {
                    hover.transition()
                        .duration(200)
                        .style("opacity", 0);
                });

            // update map colors
            g.selectAll(".state_g")
                .transition()
                .duration(600)
                .attr("fill", function (d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = Math.round((Object.values(dlist[1]["value"]["googleData"]))[diffDays]);
                    } catch (err) {
                        // meh
                    }
                    return colors(dataPoint);
                });
            g.selectAll(".state_c")
                .transition()
                .duration(600)
                .attr("fill", function (d) {
                    var dlist = d3.entries(d);
                    try {
                        var dataPoint = Math.round((Object.values(dlist[1]["value"]["covidData"]))[diffDays]);
                    } catch (err) {
                        // meh
                    }
                    return colors(dataPoint);
                });
        }

        // Legend for maps

        var legend = svg.append("defs")
            .append("svg:linearGradient")
            .attr("id", "gradient")
            .attr("x1", "10%")
            .attr("y1", "100%")
            .attr("x2", "90%")
            .attr("y2", "100%")
            .attr("spreadMethod", "pad");

        legend.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "black")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "16%")
            .attr("stop-color", "blue")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "33%")
            .attr("stop-color", "cyan")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "50%")
            .attr("stop-color", "green")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "66%")
            .attr("stop-color", "yellow")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "83%")
            .attr("stop-color", "orange")
            .attr("stop-opacity", 1);

        legend.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "red")
            .attr("stop-opacity", 1);

        svg.append("rect")
            .attr("width", "80%")
            .attr("height", 30)
            .style("fill", "url(#gradient)")
            .attr("transform", "translate(90,500)");

        var y = d3.scaleLinear()
            .range([0, width*0.8])
            .domain([0, 100]);

        var yAxis = d3.axisBottom()
            .scale(y)
            .ticks(5);

        svg.append("g")
            .attr("class", "y axis")
            .attr("transform", "translate(90,530)")
            .call(yAxis)
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 5)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("axis title");

        
        // Animating the map on button press
        var timer;
        var playing = false;
        d3.select('#play-button')
            .on('click', function() {
                // Determine whether to pause or play
                if (playing == false) {
                    // if the button is already at the end,
                    // go to the beginning
                    if (currentDate.getTime() == endDate.getTime()) {
                        currentDate = new Date('2020-02-01');
                    }
                    // set intervals
                    playing = true;
                    timer = setInterval(function() {
                        currentDate.setHours(0,0,0,0);
                        if (currentDate.getTime() == endDate.getTime()) {
                            playing = false;
                            clearInterval(timer);
                            d3.select('#play-button').html("Play");
                            return;
                        }
                        currentDate.setDate(currentDate.getDate() + 1);
                        moveHandle(currentDate);
                    }, 300);
                    d3.select(this).html("Pause");
                } else {
                    playing = false;
                    clearInterval(timer);
                    d3.select(this).html("Play");
                }
            });

    </script>



</body>